import { useEffect, useMemo, useState } from 'react'
import {
  createProject,
  fetchProjects,
  importProjectRepo,
  triggerManifest,
  triggerBuild,
  fetchBuilds,
  fetchBuild,
  scanProjectAssets,
  fetchGitHubRepos,
  createGitHubRepo,
  type ProjectSummary,
  type BuildJob,
  type GitHubRepo,
} from '../lib/api'
import { subscribeProjectsUpdated } from '../lib/events'

function TestTools() {
  const [projects, setProjects] = useState<ProjectSummary[]>([])
  const [busy, setBusy] = useState(false)
  const [logs, setLogs] = useState<string[]>([])
  const [error, setError] = useState<string | null>(null)
  const [builds, setBuilds] = useState<BuildJob[]>([])
  const [repos, setRepos] = useState<GitHubRepo[]>([])
  const [owners, setOwners] = useState<Array<{ login: string; avatarUrl: string; htmlUrl: string }>>([])
  const [selectedOrg, setSelectedOrg] = useState<string>('')
  const [newRepoName, setNewRepoName] = useState('')
  const [newRepoPrivate, setNewRepoPrivate] = useState(true)

  const sortedProjects = useMemo(
    () => [...projects].sort((a, b) => (a.updatedAt < b.updatedAt ? 1 : -1)),
    [projects],
  )

  useEffect(() => {
    let active = true

    const load = () => {
      fetchProjects()
        .then((items) => {
          if (!active) return
          setProjects(items)
          setError(null)
        })
        .catch((err: Error) => {
          if (!active) return
          setError(err.message)
        })
    }

    load()
    const unsubscribe = subscribeProjectsUpdated(load)

    return () => {
      active = false
      unsubscribe()
    }
  }, [])

  useEffect(() => {
    let active = true

    const loadBuilds = () => {
      fetchBuilds()
        .then((items) => {
          if (!active) return
          setBuilds(items)
        })
        .catch((err: Error) => appendLog(`Load builds failed: ${err.message}`))
    }

    loadBuilds()
    const interval = window.setInterval(loadBuilds, 5000)

    return () => {
      active = false
      window.clearInterval(interval)
    }
  }, [])

  useEffect(() => {
    fetchGitHubRepos()
      .then((data) => {
        setRepos(data.repos)
        const uniqueOwners = [
          { login: 'self', avatarUrl: data.owner.avatarUrl, htmlUrl: data.owner.htmlUrl },
          ...data.orgs,
        ]
        setOwners(uniqueOwners)
        setSelectedOrg((prev) => {
          if (prev && uniqueOwners.some((org) => org.login === prev)) {
            return prev
          }
          return uniqueOwners[0]?.login ?? ''
        })
      })
      .catch((err: Error) => appendLog(`Load GitHub repos failed: ${err.message}`))
  }, [])

  const appendLog = (message: string) => {
    setLogs((prev) => [
      `${new Date().toLocaleTimeString()}: ${message}`,
      ...prev.slice(0, 49),
    ])
  }

  const handleCreateSample = async () => {
    try {
      setBusy(true)
      const name = `dev-${Date.now()}`
      const project = await createProject({
        name,
        minecraftVersion: '1.21.1',
        loader: 'paper',
        description: 'Generated by Dev Tools',
      })
      appendLog(`Created project ${project.name}`)
    } catch (err) {
      appendLog(`Create failed: ${(err as Error).message}`)
    } finally {
      setBusy(false)
    }
  }

  const handleImportSample = async () => {
    try {
      setBusy(true)
      const repoUrl = 'https://github.com/example/server-template'
      const project = await importProjectRepo({
        repoUrl,
        defaultBranch: 'main',
        profilePath: 'profiles/base.yml',
      })
      appendLog(`Imported repo for ${project.name}`)
    } catch (err) {
      appendLog(`Import failed: ${(err as Error).message}`)
    } finally {
      setBusy(false)
    }
  }

  const handleManifest = async (project: ProjectSummary) => {
    try {
      setBusy(true)
      const response = await triggerManifest(project.id)
      appendLog(
        `Manifest generated for ${project.name} (${response.manifest?.lastBuildId ?? 'unknown'})`,
      )
    } catch (err) {
      appendLog(`Manifest failed: ${(err as Error).message}`)
    } finally {
      setBusy(false)
    }
  }

  const handleSeedAssets = async (project: ProjectSummary) => {
    try {
      setBusy(true)
      const assets = await scanProjectAssets(project.id)
      appendLog(
        `Scanned assets for ${project.name} (${assets.plugins.length} plugins, ${assets.configs.length} configs)`,
      )
    } catch (err) {
      appendLog(`Asset scan failed: ${(err as Error).message}`)
    } finally {
      setBusy(false)
    }
  }

  return (
    <section className="panel">
      <header>
        <h2>Developer Test Tools</h2>
        <p className="muted">
          Quick helpers for exercising backend endpoints while the UI is still under construction.
        </p>
      </header>

      <div className="dev-actions">
        <button type="button" className="primary" disabled={busy} onClick={handleCreateSample}>
          Create Sample Project
        </button>
        <button type="button" className="ghost" disabled={busy} onClick={handleImportSample}>
          Import Sample Repo
        </button>
      </div>

      {error && <p className="error-text">{error}</p>}

      <div className="dev-grid">
        <div>
          <h3>GitHub Repositories</h3>
          <form
            className="github-form"
            onSubmit={async (event) => {
              event.preventDefault()
              if (!selectedOrg || !newRepoName.trim()) {
                appendLog('Org and repo name are required')
                return
              }
              try {
                setBusy(true)
                const repo = await createGitHubRepo(selectedOrg, {
                  name: newRepoName.trim(),
                  private: newRepoPrivate,
                })
                appendLog(`Created repo ${repo.fullName}`)
                setRepos((prev) => [repo, ...prev])
                setNewRepoName('')
              } catch (err) {
                appendLog(`Repo creation failed: ${(err as Error).message}`)
              } finally {
                setBusy(false)
              }
            }}
          >
            <label htmlFor="org-select">Organization / Owner</label>
            <select
              id="org-select"
              value={selectedOrg}
              onChange={(event) => setSelectedOrg(event.target.value)}
            >
              {owners.map((owner) => (
                <option key={owner.login} value={owner.login}>
                  {owner.login}
                </option>
              ))}
            </select>

            <div className="field">
              <label htmlFor="repo-name">Repository name</label>
              <input
                id="repo-name"
                value={newRepoName}
                onChange={(event) => setNewRepoName(event.target.value)}
                placeholder="my-server-manager"
              />
            </div>

            <label className="checkbox">
              <input
                type="checkbox"
                checked={newRepoPrivate}
                onChange={(event) => setNewRepoPrivate(event.target.checked)}
              />
              Private repository
            </label>

            <button type="submit" className="primary" disabled={busy}>
              Create Repo
            </button>
          </form>

          <div className="log-box">
            {repos.length === 0 ? (
              <p className="muted">No repositories found.</p>
            ) : (
              <ul className="github-repo-list">
                {repos.map((repo) => (
                  <li key={repo.id}>
                    <strong>{repo.fullName}</strong> {repo.private ? 'üîí' : 'üåê'}{' '}
                    <a href={repo.htmlUrl} target="_blank" rel="noreferrer">
                      View
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>

        <div>
          <h3>Projects</h3>
          <ul className="project-list">
            {sortedProjects.map((project) => (
              <li key={project.id}>
                <div>
                  <h4>{project.name}</h4>
                  <p className="muted">
                    {project.minecraftVersion} ¬∑ {project.loader.toUpperCase()}{' '}
                    {project.manifest
                      ? `¬∑ Manifest ${project.manifest.lastBuildId}`
                      : '¬∑ No manifest'}
                    {project.plugins?.length
                      ? ` ¬∑ ${project.plugins.length} plugin${project.plugins.length > 1 ? 's' : ''}`
                      : ''}
                  </p>
                </div>
                <div className="dev-buttons">
                  <button
                    type="button"
                    className="ghost"
                    disabled={busy}
                    onClick={() => handleManifest(project)}
                  >
                    Generate Manifest
                  </button>
                  <button
                    type="button"
                    className="ghost"
                    disabled={busy}
                    onClick={() => handleSeedAssets(project)}
                  >
                    Scan Assets
                  </button>
                  <button
                    type="button"
                    className="ghost"
                    disabled={busy}
                    onClick={async () => {
                      try {
                        setBusy(true)
                        const build = await triggerBuild(project.id)
                        appendLog(`Queued build ${build.id} for ${project.name}`)
                        setTimeout(async () => {
                          const updated = await fetchBuild(build.id)
                          setBuilds((prev) => {
                            const copy = prev.filter((item) => item.id !== updated.id)
                            return [updated, ...copy]
                          })
                        }, 1500)
                      } catch (err) {
                        appendLog(`Build failed to queue: ${(err as Error).message}`)
                      } finally {
                        setBusy(false)
                      }
                    }}
                  >
                    Trigger Build
                  </button>
                </div>
              </li>
            ))}
          </ul>
          {sortedProjects.length === 0 && (
            <p className="empty-state">No projects yet. Use the buttons above to seed data.</p>
          )}
        </div>

        <div>
          <h3>Builds</h3>
          <div className="log-box">
            {builds.length === 0 && <p className="muted">No builds queued yet.</p>}
            {builds.length > 0 && (
              <ul>
                {builds.map((build) => (
                  <li key={build.id}>
                    <strong>{build.projectId}</strong> ¬∑ {build.status.toUpperCase()} ¬∑{' '}
                    {build.finishedAt
                      ? new Date(build.finishedAt).toLocaleTimeString()
                      : new Date(build.createdAt).toLocaleTimeString()}
                    {build.error ? ` ‚Äî ${build.error}` : ''}
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>

        <div>
          <h3>Activity Log</h3>
          <div className="log-box">
            {logs.length === 0 && <p className="muted">Actions will appear here.</p>}
            {logs.length > 0 && (
              <ul>
                {logs.map((entry, index) => (
                  <li key={index}>{entry}</li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </div>
    </section>
  )
}

export default TestTools

